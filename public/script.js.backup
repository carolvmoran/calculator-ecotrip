// Elementos do DOM
const form = document.getElementById("emission-form");
const manualDistanceCheckbox = document.getElementById("manual-distance");
const distanceGroup = document.getElementById("distance-group");
const distanceInput = document.getElementById("distance");
const origemInput = document.getElementById("origem");
const destinoInput = document.getElementById("destino");
const transportButtons = document.querySelectorAll(".transport-btn");
const transportInput = document.getElementById("transport");
const errorMessage = document.getElementById("error-message");
const resultsSection = document.getElementById("results");

// Verificar se todos os elementos necess√°rios existem
if (
  !form ||
  !manualDistanceCheckbox ||
  !distanceGroup ||
  !distanceInput ||
  !origemInput ||
  !destinoInput ||
  !transportInput ||
  !errorMessage ||
  !resultsSection
) {
  console.error("Erro: Elementos do formul√°rio n√£o foram encontrados no HTML");
}

// Mapear valores para nomes amig√°veis
const transportNames = {
  bike: "üö¥ Bicicleta",
  car: "üöó Carro",
  bus: "üöå √înibus",
  truck: "üöö Caminh√£o",
};

// Vari√°vel para armazenar transporte selecionado
let selectedTransport = null;

// Controlar checkbox de dist√¢ncia manual
if (manualDistanceCheckbox && distanceGroup && distanceInput) {
  manualDistanceCheckbox.addEventListener("change", (e) => {
    if (e.target.checked) {
      distanceGroup.style.display = "block";
      distanceInput.required = true;
    } else {
      distanceGroup.style.display = "none";
      distanceInput.required = false;
      distanceInput.value = "";
    }
  });
}

// Controlar sele√ß√£o de transporte
if (transportButtons.length > 0) {
  transportButtons.forEach((button) => {
    button.addEventListener("click", (e) => {
      e.preventDefault();

      // Remove active de todos os bot√µes
      transportButtons.forEach((btn) => btn.classList.remove("active"));

      // Adiciona active no bot√£o clicado
      button.classList.add("active");

      // Armazena o transporte selecionado
      selectedTransport = button.dataset.transport;
      if (transportInput) {
        transportInput.value = selectedTransport;
      }

      // Remove erro se existir
      if (errorMessage && errorMessage.style.display === "block") {
        errorMessage.style.display = "none";
      }
    });
  });
}

// Fun√ß√£o para exibir erro
function showError(message) {
  if (!errorMessage || !resultsSection) return;

  errorMessage.textContent = message;
  errorMessage.style.display = "block";
  resultsSection.style.display = "none";

  // Scroll suave para o erro
  errorMessage.scrollIntoView({ behavior: "smooth", block: "center" });

  // Esconder erro ap√≥s 5 segundos
  setTimeout(() => {
    errorMessage.style.display = "none";
  }, 5000);
}

// Fun√ß√£o para exibir resultado
function showResult(data) {
  if (!errorMessage || !resultsSection) return;

  // Esconder mensagem de erro
  errorMessage.style.display = "none";

  // Preencher valores do resultado
  const co2ResultElement = document.getElementById("co2-result");
  const resultOrigemElement = document.getElementById("result-origem");
  const resultDestinoElement = document.getElementById("result-destino");
  const resultDistanceElement = document.getElementById("result-distance");
  const resultTransportElement = document.getElementById("result-transport");

  if (co2ResultElement) co2ResultElement.textContent = data.emission;
  if (resultOrigemElement) resultOrigemElement.textContent = data.origem;
  if (resultDestinoElement) resultDestinoElement.textContent = data.destino;
  if (resultDistanceElement) resultDistanceElement.textContent = data.distance;
  if (resultTransportElement)
    resultTransportElement.textContent = transportNames[data.transport];

  // Exibir se√ß√£o de resultado
  resultsSection.style.display = "block";

  // Scroll suave para o resultado
  resultsSection.scrollIntoView({ behavior: "smooth", block: "start" });
}

// Manipular envio do formul√°rio
if (form) {
  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    // Verificar se os inputs existem antes de acessar
    if (!origemInput || !destinoInput || !distanceInput) {
      console.error("Erro: Campos do formul√°rio n√£o encontrados");
      return;
    }

    // Coletar dados do formul√°rio
    const origem = origemInput.value.trim();
    const destino = destinoInput.value.trim();
    const distance = parseFloat(distanceInput.value);
    const transport = selectedTransport;

    // Valida√ß√£o no frontend
    if (!origem) {
      showError("Por favor, informe a cidade de origem");
      return;
    }

    if (!destino) {
      showError("Por favor, informe a cidade de destino");
      return;
    }

    if (!manualDistanceCheckbox || !manualDistanceCheckbox.checked) {
      showError('Por favor, marque a op√ß√£o "Inserir dist√¢ncia manualmente"');
      return;
    }

    if (!distance || distance <= 0) {
      showError("Por favor, informe uma dist√¢ncia v√°lida maior que zero");
      return;
    }

    if (!transport) {
      showError("Por favor, selecione um meio de transporte");
      return;
    }

    // Desabilitar bot√£o durante o envio
    const submitButton = form.querySelector('button[type="submit"]');
    if (!submitButton) return;

    const originalButtonText = submitButton.textContent;
    submitButton.textContent = "Calculando...";
    submitButton.disabled = true;

    try {
      // Enviar requisi√ß√£o POST para /calculate
      const response = await fetch("http://localhost:3000/calculate", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          distance: distance,
          transport: transport,
        }),
      });

      const result = await response.json();

      if (response.ok) {
        // Exibir resultado formatado em kg de CO‚ÇÇ
        showResult({
          emission: result.emission,
          origem: origem,
          destino: destino,
          distance: distance,
          transport: transport,
        });
      } else {
        // Exibir mensagens de erro retornadas pela API
        showError(
          result.error || "Erro ao calcular emiss√µes. Tente novamente.",
        );
      }
    } catch (error) {
      console.error("Erro na requisi√ß√£o:", error);
      showError(
        "Erro de conex√£o com o servidor. Verifique se o servidor est√° rodando.",
      );
    } finally {
      // Reabilitar bot√£o
      submitButton.textContent = originalButtonText;
      submitButton.disabled = false;
    }
  });
}

// Limpar mensagens de erro ao digitar
if (origemInput && destinoInput && distanceInput && errorMessage) {
  const inputs = [origemInput, destinoInput, distanceInput];
  inputs.forEach((input) => {
    if (input) {
      input.addEventListener("input", () => {
        if (errorMessage.style.display === "block") {
          errorMessage.style.display = "none";
        }
      });
    }
  });
}
